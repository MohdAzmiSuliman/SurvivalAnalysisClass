---
title: "SurvivalAnalysisPrac"
author: "Mohd Azmi"
date: "15/11/2019"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

## Library

```{r "Library", message=FALSE}
library(haven)
library(dplyr)
library(psych)
library(lubridate)
library(knitr)
library(ggplot2)
library(survival)
library(broom)
library(survminer)
```

## Import Dataset

```{r "Dataset", message=FALSE}
DataSet <- read_dta("stroke_outcome.dta")
DataSet <- DataSet %>%
  mutate_if(is.labelled, funs(as_factor(.)))
kable(head(DataSet))
```

alternatively

```{r}
DataSet2 <- read_dta("stroke_outcome.dta")
DataSet2 <- DataSet %>%
  mutate(sex = as_factor(sex),
         race = as_factor(race),
         event = as_factor(event),
         dm2 = as_factor(dm2),
         hpt2 = as_factor(hpt2),
         race2 = as_factor(race2),
         event_s = as_factor(event_s))
kable(head(DataSet2))
```

# Descriptive Analysis and Data Exploration

## Summary

```{r , message=FALSE}
kable(summary(DataSet))
kable(describe(DataSet))
```

count duration between 2 date

```{r}
DataSet$Dur_Days <- as.duration(DataSet$doa %--% DataSet$dod) / ddays(1)
kable(head(DataSet))
```

group data by event, and descriptive analysis

- numerical data

```{r}
DataSet %>%
  group_by(event) %>%
  summarise(Mean_Age = mean(age), SD_Age = sd(age),
            Mean_GCS = mean(gcs), SD_GCS = sd(gcs),
            Mean_SBP = mean(sbp), SD_SBP = sd(age),
            Mean_DBP = mean(dbp), SD_DBP = sd(dbp),
            ) %>%
  kable()
```


- categorical data
```{r}
DataSet %>%
  count(event, sex) %>%
  kable()

ggplot(DataSet, aes(x=factor(event), fill=factor(event))) +
  geom_bar() +
  facet_wrap(~sex)

DataSet %>%
  count(event, race) %>%
  kable()

ggplot(DataSet, aes(x=factor(event), fill=factor(event))) +
  geom_bar() +
  facet_wrap(~race)

DataSet %>%
  count(event, dm2) %>%
  kable()

ggplot(DataSet, aes(x=factor(event), fill=factor(event))) +
  geom_bar() +
  facet_wrap(~dm2)

DataSet %>%
  count(event, hpt2) %>%
  kable()

ggplot(DataSet, aes(x=factor(event), fill=factor(event))) +
  geom_bar() +
  facet_wrap(~hpt2)

DataSet %>%
  count(event, race2) %>%
  kable()

ggplot(DataSet, aes(x=factor(event), fill=factor(event))) +
  geom_bar() +
  facet_wrap(~race2)

```

# Univariable

## Overall Model

### Kaplan-Meier Survival Estimates


```{r}
Overall_KM <- survfit(Surv(time = Dur_Days, event == "dead") ~ 1,
                      data = DataSet,
                      type = "kaplan-meier")
summary(Overall_KM)
kable(tidy(Overall_KM))
```

### KM Plot

```{r}
ggsurvplot(Overall_KM,
           data = DataSet,
           risk.table = T,
           linetype = c(1,2),
           pval = T)
```

## Univariable - IV - gender

### KM Estimate

```{r}
KM_gender <- survfit(Surv(time = Dur_Days, event == "dead") ~ sex,
                     data = DataSet,
                     type = "kaplan-meier")
summary(KM_gender)
kable(tidy(KM_gender))
```

### KM Plot

```{r}
ggsurvplot(KM_gender,
           data = DataSet,
           risk.table = T,
           linetype = c(1,2),
           pval = T)
```

p = 0.41, thus no significant difference between survival in male or female.

## Univariable - IV - DM

### KM Estimate

```{r}
KM_DM <- survfit(Surv(time = Dur_Days, event == "dead") ~ dm2,
                 data = DataSet,
                 type = "kaplan-meier")
summary(KM_DM)
kable(tidy(KM_DM))
```

### KM Plot

```{r}
ggsurvplot(KM_DM,
           data = DataSet,
           risk.table = T,
           linetype = c(1,2),
           pval = T)
```

p < 0.05, thus there is significant different between DM yes and DM no

### Survival Function Estimate

estimate number of survival at Q1, median and Q3


```{r}
kable(quantile(KM_DM, probs = c(0.25, 0.5, 0.75)))
```

### Survival Probability Estimate

estimate time of survival at times = 20, 40 and 60 units of time

```{r}
summary(KM_DM, times = c(20, 40, 60))
```
















